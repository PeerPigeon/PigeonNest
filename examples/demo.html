<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PigeonNest Demo - Vue 3 Framework for PeerPigeon</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f5f5f5;
      padding: 20px;
    }
    
    #app {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
    }
    
    .demo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .demo-section {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .demo-section h2 {
      font-size: 18px;
      margin-bottom: 16px;
      color: #333;
      border-bottom: 2px solid #1976d2;
      padding-bottom: 8px;
    }
    
    .control-group {
      margin-bottom: 16px;
    }
    
    .control-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #666;
      font-size: 14px;
    }
    
    input[type="text"] {
      width: 100%;
      padding: 10px;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      font-size: 14px;
    }
    
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    button.primary {
      background: #1976d2;
      color: white;
    }
    
    button.primary:hover:not(:disabled) {
      background: #1565c0;
    }
    
    button.secondary {
      background: #f5f5f5;
      color: #333;
      border: 1px solid #e0e0e0;
    }
    
    button.secondary:hover:not(:disabled) {
      background: #e0e0e0;
    }
    
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .button-group {
      display: flex;
      gap: 8px;
    }
    
    .message-log {
      background: #fafafa;
      border: 1px solid #e0e0e0;
      border-radius: 4px;
      padding: 12px;
      max-height: 300px;
      overflow-y: auto;
      font-size: 13px;
      font-family: monospace;
    }
    
    .message-item {
      padding: 6px 0;
      border-bottom: 1px solid #e0e0e0;
    }
    
    .message-item:last-child {
      border-bottom: none;
    }
    
    .streams-container {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
  </style>
</head>
<body>
  <div id="app">
    <h1>üê¶ PigeonNest Demo</h1>
    <p style="text-align: center; color: #666; margin-bottom: 30px;">
      Vue 3 Framework for PeerPigeon - WebRTC Mesh Networking with Streaming
    </p>
    
    <div class="demo-grid">
      <!-- Connection Control -->
      <div class="demo-section">
        <h2>Connection</h2>
        <div class="control-group">
          <label>Signaling Server URL</label>
          <input 
            v-model="hubUrl" 
            type="text" 
            placeholder="ws://localhost:3000"
          />
        </div>
        <div class="button-group">
          <button 
            class="primary" 
            @click="initialize" 
            :disabled="isInitialized"
          >
            Initialize
          </button>
          <button 
            class="primary" 
            @click="connectToHub" 
            :disabled="!isInitialized || isConnected"
          >
            Connect
          </button>
          <button 
            class="secondary" 
            @click="disconnect" 
            :disabled="!isConnected"
          >
            Disconnect
          </button>
        </div>
      </div>
      
      <!-- Status -->
      <div class="demo-section">
        <h2>Status</h2>
        <peer-connection-status 
          :status="status" 
          :is-connected="isConnected"
        />
      </div>
    </div>
    
    <div class="demo-grid">
      <!-- Peers List -->
      <div class="demo-section">
        <h2>Connected Peers</h2>
        <peer-list 
          :peers="connectedPeerIds.map(id => ({ peerId: id, discoveredAt: Date.now() }))"
          @select="selectedPeer = $event"
          @message="openMessageDialog"
          @file="openFileDialog"
          :selected-peer-id="selectedPeer"
        />
      </div>
      
      <!-- File Upload -->
      <div class="demo-section">
        <h2>Send Files</h2>
        <div v-if="selectedPeer" style="margin-bottom: 12px; padding: 8px; background: #e3f2fd; border-radius: 4px; font-size: 13px;">
          üì§ Sending to: <strong>{{ selectedPeer.substring(0, 8) }}...</strong>
        </div>
        <div v-else style="margin-bottom: 12px; padding: 8px; background: #fff3e0; border-radius: 4px; font-size: 13px;">
          ‚ö†Ô∏è Select a peer first
        </div>
        <file-upload 
          :target-peer-id="selectedPeer"
          @upload="handleFileUpload"
          :multiple="true"
        />
      </div>
    </div>
    
    <!-- Active Streams -->
    <div v-if="activeStreamsArray.length > 0" class="demo-section">
      <h2>Active Transfers</h2>
      <div class="streams-container">
        <stream-progress 
          v-for="stream in activeStreamsArray" 
          :key="stream.streamId"
          :stream="stream"
          @cancel="cancelStream"
          @dismiss="dismissStream"
        />
      </div>
    </div>
    
    <!-- Message Log -->
    <div class="demo-section">
      <h2>Event Log</h2>
      <div class="message-log">
        <div v-for="(msg, index) in messages" :key="index" class="message-item">
          <strong>[{{ formatTime(msg.timestamp) }}]</strong> {{ msg.text }}
        </div>
        <div v-if="messages.length === 0" style="color: #999; text-align: center; padding: 20px;">
          No events yet
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { createApp } from 'vue'
    import { 
      usePeerPigeon, 
      usePeerStreaming,
      PeerConnectionStatus,
      PeerList,
      FileUpload,
      StreamProgress
    } from '../src/index.ts'
    
    const app = createApp({
      components: {
        PeerConnectionStatus,
        PeerList,
        FileUpload,
        StreamProgress
      },
      setup() {
        const hubUrl = Vue.ref('ws://localhost:3000')
        const selectedPeer = Vue.ref(null)
        const messages = Vue.ref([])
        
        const {
          mesh,
          status,
          isConnected,
          isInitialized,
          connectedPeerIds,
          discoveredPeers,
          init,
          connect,
          disconnect: disconnectMesh,
          sendMessage,
          broadcast
        } = usePeerPigeon({
          networkName: 'pigeonnest-demo',
          maxPeers: 5,
          minPeers: 1
        })
        
        const {
          activeStreams,
          sendFile,
          sendBlob,
          receiveStream,
          cancelStream: cancelStreamComposable
        } = usePeerStreaming()
        
        const addMessage = (text) => {
          messages.value.unshift({
            text,
            timestamp: Date.now()
          })
          if (messages.value.length > 50) {
            messages.value = messages.value.slice(0, 50)
          }
        }
        
        const initialize = async () => {
          try {
            await init()
            addMessage('‚úÖ Mesh initialized')
            
            // Set up event listeners
            if (mesh.value) {
              mesh.value.addEventListener('peerConnected', (e) => {
                addMessage(`üîó Peer connected: ${e.peerId.substring(0, 8)}...`)
              })
              
              mesh.value.addEventListener('peerDisconnected', (e) => {
                addMessage(`‚ùå Peer disconnected: ${e.peerId.substring(0, 8)}...`)
              })
              
              mesh.value.addEventListener('message', (e) => {
                addMessage(`üí¨ Message from ${e.peerId.substring(0, 8)}...: ${e.data}`)
              })
              
              mesh.value.addEventListener('streamReceived', async (e) => {
                addMessage(`üì• Receiving file: ${e.metadata.filename}`)
                try {
                  const blob = await receiveStream(e)
                  addMessage(`‚úÖ File received: ${e.metadata.filename}`)
                  
                  // Trigger download
                  const url = URL.createObjectURL(blob)
                  const a = document.createElement('a')
                  a.href = url
                  a.download = e.metadata.filename
                  a.click()
                  URL.revokeObjectURL(url)
                } catch (err) {
                  addMessage(`‚ùå Error receiving file: ${err.message}`)
                }
              })
            }
          } catch (err) {
            addMessage(`‚ùå Initialization failed: ${err.message}`)
          }
        }
        
        const connectToHub = async () => {
          try {
            await connect(hubUrl.value)
            addMessage(`‚úÖ Connected to hub: ${hubUrl.value}`)
          } catch (err) {
            addMessage(`‚ùå Connection failed: ${err.message}`)
          }
        }
        
        const disconnect = () => {
          disconnectMesh()
          addMessage('üîå Disconnected')
        }
        
        const handleFileUpload = async (files) => {
          if (!selectedPeer.value) {
            addMessage('‚ùå No peer selected')
            return
          }
          
          for (const file of files) {
            try {
              addMessage(`üì§ Sending ${file.name} to ${selectedPeer.value.substring(0, 8)}...`)
              await sendFile(mesh.value, selectedPeer.value, file)
              addMessage(`‚úÖ Sent ${file.name}`)
            } catch (err) {
              addMessage(`‚ùå Failed to send ${file.name}: ${err.message}`)
            }
          }
        }
        
        const openMessageDialog = (peerId) => {
          const message = prompt('Enter message:')
          if (message && mesh.value) {
            sendMessage(peerId, message)
            addMessage(`üí¨ Sent message to ${peerId.substring(0, 8)}...`)
          }
        }
        
        const openFileDialog = (peerId) => {
          selectedPeer.value = peerId
          addMessage(`üìÅ Selected peer for file transfer: ${peerId.substring(0, 8)}...`)
        }
        
        const cancelStream = (streamId) => {
          cancelStreamComposable(streamId)
          addMessage(`üö´ Cancelled stream: ${streamId}`)
        }
        
        const dismissStream = (streamId) => {
          activeStreams.value.delete(streamId)
          activeStreams.value = new Map(activeStreams.value)
        }
        
        const activeStreamsArray = Vue.computed(() => 
          Array.from(activeStreams.value.values())
        )
        
        const formatTime = (timestamp) => {
          const date = new Date(timestamp)
          return date.toLocaleTimeString()
        }
        
        return {
          hubUrl,
          selectedPeer,
          messages,
          status,
          isConnected,
          isInitialized,
          connectedPeerIds,
          discoveredPeers,
          activeStreamsArray,
          initialize,
          connectToHub,
          disconnect,
          handleFileUpload,
          openMessageDialog,
          openFileDialog,
          cancelStream,
          dismissStream,
          formatTime
        }
      }
    })
    
    app.mount('#app')
  </script>
</body>
</html>
